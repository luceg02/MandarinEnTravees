{% extends 'base.html.twig' %}

{% block title %}{{ demande.titre }} - Le Mandarin en Trav√©es{% endblock %}

{% block stylesheets %}
    {{ parent() }}
    <link rel="stylesheet" href="{{ asset('css/detail.css') }}">
{% endblock %}

{% block body %}
<div class="container py-5">
    <!-- Navigation breadcrumb -->
    <nav aria-label="breadcrumb" class="mb-4">
        <ol class="breadcrumb">
            <li class="breadcrumb-item">
                <a href="{{ path('app_home') }}" class="text-decoration-none">
                    <i class="fas fa-home me-1"></i>Accueil
                </a>
            </li>
            <li class="breadcrumb-item active" aria-current="page">
                <i class="fas fa-file-alt me-1"></i>D√©tail de la demande
            </li>
        </ol>
    </nav>

    <div class="row">
        <!-- Contenu principal -->
        <div class="col-lg-8">
            <!-- üÜï En-t√™te de la demande avec verdict int√©gr√© -->
            <div class="demande-header">
                <div class="d-flex justify-content-between align-items-start mb-3">
                    <div class="d-flex gap-2 flex-wrap">
                        {# ===== SEULEMENT LES CAT√âGORIES (plus de statut redondant) ===== #}
                        {% if demande.categorie %}
                            <span class="badge bg-light text-dark status-badge">
                                <i class="fas fa-tag me-2"></i>{{ demande.categorie.nom }}
                            </span>
                        {% endif %}
                    </div>
                    
                    <small class="text-white-50">
                        ID #{{ demande.id }}
                    </small>
                </div>
                
                <h1 class="h2 fw-bold mb-3">{{ demande.titre }}</h1>

                <div class="d-flex justify-content-between align-items-center text-white-50 mb-3">
                    <div class="d-flex align-items-center">
                        <i class="fas fa-calendar-alt me-2"></i>
                        Publi√© le {{ demande.dateCreation|date('d/m/Y √† H:i') }}
                    </div>
                    <div class="d-flex align-items-center">
                        <i class="fas fa-comments me-2"></i>
                        {{ demande.nbReponses }} contribution{{ demande.nbReponses > 1 ? 's' : '' }}
                    </div>
                </div>

                {# ===== üÜï VERDICT INT√âGR√â DANS LE HEADER ===== #}
                {% if demande.verdictAutomatique %}
                    <div class="verdict-integre d-flex align-items-center">
                        <div class="verdict-icon">
                            <i class="{{ demande.iconeVerdict }}"></i>
                        </div>
                        <div class="flex-grow-1">
                            <div class="verdict-text">
                                Verdict de la communaut√© : {{ demande.libelleVerdict }}
                            </div>
                            <div class="verdict-details">
                                Confiance : {{ demande.scoreConfiance|round }}% ‚Ä¢ 
                                Bas√© sur {{ demande.votesVeracite|length }} √©valuations
                            </div>
                        </div>
                        {# Badge de fiabilit√© #}
                        {% set confiance = demande.scoreConfiance|round %}
                        {% if confiance >= 80 %}
                            <span class="badge bg-success ms-3 px-3 py-2">
                                <i class="fas fa-shield-alt me-1"></i>
                                <strong>FIABLE</strong>
                            </span>
                        {% elseif confiance >= 60 %}
                            <span class="badge bg-warning text-dark ms-3 px-3 py-2">
                                <i class="fas fa-exclamation-triangle me-1"></i>
                                <strong>MOD√âR√â</strong>
                            </span>
                        {% elseif confiance >= 40 %}
                            <span class="badge bg-danger ms-3 px-3 py-2">
                                <i class="fas fa-times-circle me-1"></i>
                                <strong>DOUTEUX</strong>
                            </span>
                        {% else %}
                            <span class="badge bg-secondary ms-3 px-3 py-2">
                                <i class="fas fa-question-circle me-1"></i>
                                <strong>INCONNU</strong>
                            </span>
                        {% endif %}
                    </div>
                {% else %}
                    <div class="verdict-integre d-flex align-items-center">
                        <div class="verdict-icon">
                            <i class="fas fa-clock"></i>
                        </div>
                        <div class="flex-grow-1">
                            <div class="verdict-text">
                                V√©rification en cours...
                            </div>
                            <div class="verdict-details">
                                {{ demande.votesVeracite|length }} √©valuations re√ßues ‚Ä¢ 
                                Contribuez pour aider √† √©valuer cette information !
                            </div>
                        </div>
                        <span class="badge bg-info ms-3 px-3 py-2">
                            <i class="fas fa-hourglass-half me-1"></i>
                            <strong>EN COURS</strong>
                        </span>
                    </div>
                {% endif %}
            </div>

            <!-- Section INFORMATIONS SUR LA DEMANDE -->
            <div class="demande-section p-3 mb-3">
                <div class="d-flex align-items-center mb-3">
                    <div class="me-3">
                        <div class="text-white rounded-circle d-flex align-items-center justify-content-center" 
                             style="width: 40px; height: 40px; background-color: #667eea;">
                            <i class="fas fa-info-circle"></i>
                        </div>
                    </div>
                    <div>
                        <h2 class="h5 mb-0 fw-bold" style="color: #667eea;">Informations sur la demande</h2>
                        <small class="text-muted">Demande et documents fournis par l'auteur</small>
                    </div>
                </div>

                <!-- D'ABORD : Auteur (pleine largeur) -->
                <div class="row mb-3">
                    <div class="col-12">
                        <div class="card border" style="border-color: #667eea !important;">
                            <div class="card-header text-white" style="background-color: #667eea;">
                                <h4 class="h6 mb-0">
                                    <i class="fas fa-user me-2"></i>
                                    Auteur de la demande
                                </h4>
                            </div>
                            <div class="card-body">
                                <div class="d-flex align-items-center">
                                    <div class="me-3">
                                        <div class="timeline-badge" style="background-color: #667eea;">
                                            {% if demande.auteur.isJournaliste is defined and demande.auteur.isJournaliste %}
                                                <i class="fas fa-newspaper"></i>
                                            {% else %}
                                                <i class="fas fa-user"></i>
                                            {% endif %}
                                        </div>
                                    </div>
                                    <div class="flex-grow-1">
                                        <div class="d-flex align-items-center justify-content-between">
                                            <div>
                                                <h6 class="mb-1 fw-bold">
                                                    {% if demande.auteur.prenom or demande.auteur.nom %}
                                                        {{ demande.auteur.prenom }} {{ demande.auteur.nom }}
                                                    {% else %}
                                                        {{ demande.auteur.email|split('@')[0] }}
                                                    {% endif %}
                                                </h6>
                                                <small class="text-muted">
                                                    {% if demande.auteur.isJournaliste is defined and demande.auteur.isJournaliste %}
                                                        <i class="fas fa-star me-1" style="color: #f59e0b;"></i>Journaliste accr√©dit√©
                                                    {% else %}
                                                        <i class="fas fa-users me-1"></i>Contributeur
                                                    {% endif %}
                                                </small>
                                            </div>
                                            <div class="text-end">
                                                <!-- Syst√®me de scoring coh√©rent -->
                                                {% if demande.auteur.isJournaliste is defined and demande.auteur.isJournaliste %}
                                                    <span class="badge text-dark" style="background-color: #f59e0b;">
                                                        <i class="fas fa-newspaper me-1"></i>Journaliste
                                                    </span>
                                                {% else %}
                                                    {% set score = demande.auteur.scoreReputation ?? 0 %}
                                                    {% set pourcentage = (score * 100 / 100)|round %}
                                                    {% if pourcentage >= 80 %}
                                                        <span class="badge text-white" style="background-color: #10b981;">
                                                            <i class="fas fa-star"></i> {{ pourcentage }}% - Expert
                                                        </span>
                                                    {% elseif pourcentage >= 60 %}
                                                        <span class="badge text-white" style="background-color: #667eea;">
                                                            <i class="fas fa-thumbs-up"></i> {{ pourcentage }}% - Fiable
                                                        </span>
                                                    {% elseif pourcentage >= 30 %}
                                                        <span class="badge text-dark" style="background-color: #f59e0b;">
                                                            <i class="fas fa-user-check"></i> {{ pourcentage }}% - Correct
                                                        </span>
                                                    {% elseif pourcentage > 0 %}
                                                        <span class="badge text-white" style="background-color: #f97316;">
                                                            <i class="fas fa-exclamation-triangle"></i> {{ pourcentage }}% - D√©butant
                                                        </span>
                                                    {% else %}
                                                        <span class="badge text-dark" style="background-color: #e5e7eb;">
                                                            <i class="fas fa-user-plus"></i> 0% - Nouveau
                                                        </span>
                                                    {% endif %}
                                                {% endif %}
                                                <br>
                                                <small class="text-muted">
                                                    <i class="fas fa-calendar-alt me-1"></i>
                                                    Membre depuis {{ demande.auteur.dateInscription ? demande.auteur.dateInscription|date('m/Y') : 'N/A' }}
                                                </small>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- ENSUITE : Description et Sources c√¥te √† c√¥te -->
                <div class="row">
                    <!-- Description -->
                    <div class="col-lg-8 mb-3">
                        <div class="card h-100 border" style="border-color: #667eea !important;">
                            <div class="card-header text-white" style="background-color: #667eea;">
                                <h4 class="h6 mb-0">
                                    <i class="fas fa-align-left me-2"></i>
                                    Description de la demande
                                </h4>
                            </div>
                            <div class="card-body">
                                <p class="mb-0 lh-lg">{{ demande.description|nl2br }}</p>
                            </div>
                        </div>
                    </div>

                    <!-- Sources -->
                    <div class="col-lg-4 mb-3">
                        {% if demande.liensSources is defined and demande.liensSources %}
                            <div class="card h-100 border" style="border-color: #667eea !important;">
                                <div class="card-header text-white" style="background-color: #667eea;">
                                    <h4 class="h6 mb-0">
                                        <i class="fas fa-link me-2"></i>
                                        Sources fournies
                                    </h4>
                                </div>
                                <div class="card-body">
                                    {% set sources = demande.liensSources|split('\n') %}
                                    {% for source in sources %}
                                        {% if source|trim %}
                                            <div class="mb-2">
                                                {% if 'http' in source %}
                                                    <i class="fas fa-external-link-alt me-2" style="color: #667eea;"></i>
                                                    <a href="{{ source|trim }}" target="_blank" class="text-decoration-none" style="color: #667eea;">
                                                        {{ source|trim|length > 30 ? source|trim|slice(0, 30) ~ '...' : source|trim }}
                                                    </a>
                                                {% elseif 'Image:' in source %}
                                                <div class="uploaded-image">
                                                    <i class="fas fa-image text-info me-1"></i>
                                                    <span class="small text-muted d-block mb-1">{{ source|trim }}</span>
                                                    {% set imageName = source|replace({'Image: ': ''}) %}
                                                    <img src="{{ asset('uploads/images/' ~ imageName|trim) }}" 
                                                        alt="Image partag√©e" 
                                                        class="img-fluid rounded shadow-sm" 
                                                        style="max-width: 100%; max-height: 100px; object-fit: cover;">
                                                </div>
                                                {% else %}
                                                    <i class="fas fa-file-alt text-secondary me-1"></i>
                                                    <span class="small">{{ source|trim }}</span>
                                                {% endif %}
                                            </div>
                                        {% endif %}
                                    {% endfor %}
                                </div>
                            </div>
                        {% else %}
                            <div class="card h-100 border-0">
                                <div class="card-body d-flex align-items-center justify-content-center text-muted">
                                    <div class="text-center">
                                        <i class="fas fa-file-alt fa-2x mb-2"></i>
                                        <p class="mb-0 small">Aucune source fournie</p>
                                    </div>
                                </div>
                            </div>
                        {% endif %}
                    </div>
                </div>
            </div>

            <!-- S√âPARATEUR VISUEL -->
            <div class="section-divider mb-3">
                <div class="d-flex align-items-center">
                    <div class="flex-grow-1 bg-gradient" style="height: 3px; border-radius: 5px; background: linear-gradient(90deg, #667eea 0%, #1e5a8a 100%);"></div>
                    <div class="flex-grow-1 bg-gradient" style="height: 3px; border-radius: 5px; background: linear-gradient(90deg, #1e5a8a 0%, #667eea 100%);"></div>
                </div>
            </div>

            <!-- üÜï FORMULAIRE DE CONTRIBUTION AVEC VOTE DE V√âRACIT√â -->
            {% if app.user and form is defined and form %}
                <div class="card mb-4">
                    <div class="card-header bg-primary text-white">
                        <h6><i class="fas fa-plus me-2"></i>Contribuer √† cette v√©rification</h6>
                    </div>
                    <div class="card-body">
                        {{ form_start(form, {'attr': {'id': 'form-contribution'}}) }}
                            
                            {# ===== 1. CONTENU DE LA R√âPONSE ===== #}
                            <div class="mb-3">
                                <label for="{{ form.contenu.vars.id }}" class="form-label">
                                    <i class="fas fa-comment me-2"></i>Votre contribution
                                    <span class="text-danger">*</span>
                                </label>
                                {{ form_widget(form.contenu, {'attr': {'class': 'form-control', 'rows': '4', 'placeholder': 'Apportez des √©l√©ments de r√©ponse, des pr√©cisions, des sources...'}}) }}
                            </div>

                            {# ===== 2. SOURCES (OPTIONNEL) ===== #}
                            <div class="mb-3">
                                {{ form_row(form.sources) }}
                            </div>

                            {# ===== 3. IMAGE (OPTIONNEL) ===== #}
                            {% if form.imageFile is defined %}
                                <div class="mb-3">
                                    {{ form_row(form.imageFile) }}
                                </div>
                            {% endif %}

                            {# ===== 4. üÜï VOTE DE V√âRACIT√â OBLIGATOIRE ===== #}
                            <div class="mb-4 p-3 border rounded bg-light">
                                <label class="form-label fw-bold mb-3">
                                    <i class="fas fa-balance-scale me-2"></i>
                                    Votre √©valuation de cette information :
                                    <span class="text-danger">*</span>
                                </label>
                                
                                <div class="row g-3">
                                    <div class="col-md-6">
                                        <label class="d-flex align-items-start p-3 border rounded vote-option h-100">
                                            <input type="radio" name="type_veracite" value="vrai" class="me-3 mt-1" required>
                                            <div>
                                                <div class="d-flex align-items-center mb-2">
                                                    <i class="fas fa-check-circle text-success me-2 fs-5"></i>
                                                    <strong>Vraie</strong>
                                                </div>
                                                <small class="text-muted">L'information est exacte et v√©rifiable par des sources fiables</small>
                                            </div>
                                        </label>
                                    </div>
                                    
                                    <div class="col-md-6">
                                        <label class="d-flex align-items-start p-3 border rounded vote-option h-100">
                                            <input type="radio" name="type_veracite" value="faux" class="me-3 mt-1" required>
                                            <div>
                                                <div class="d-flex align-items-center mb-2">
                                                    <i class="fas fa-times-circle text-danger me-2 fs-5"></i>
                                                    <strong>Fausse</strong>
                                                </div>
                                                <small class="text-muted">L'information est incorrecte ou mensong√®re</small>
                                            </div>
                                        </label>
                                    </div>
                                    
                                    <div class="col-md-6">
                                        <label class="d-flex align-items-start p-3 border rounded vote-option h-100">
                                            <input type="radio" name="type_veracite" value="trompeur" class="me-3 mt-1" required>
                                            <div>
                                                <div class="d-flex align-items-center mb-2">
                                                    <i class="fas fa-exclamation-triangle text-warning me-2 fs-5"></i>
                                                    <strong>Trompeuse</strong>
                                                </div>
                                                <small class="text-muted">Partiellement vraie mais sortie de son contexte ou exag√©r√©e</small>
                                            </div>
                                        </label>
                                    </div>
                                    
                                    <div class="col-md-6">
                                        <label class="d-flex align-items-start p-3 border rounded vote-option h-100">
                                            <input type="radio" name="type_veracite" value="non_identifiable" class="me-3 mt-1" required>
                                            <div>
                                                <div class="d-flex align-items-center mb-2">
                                                    <i class="fas fa-question-circle text-secondary me-2 fs-5"></i>
                                                    <strong>V√©racit√© non identifiable</strong>
                                                </div>
                                                <small class="text-muted">Impossible √† v√©rifier avec les √©l√©ments disponibles</small>
                                            </div>
                                        </label>
                                    </div>
                                </div>
                                
                                {# Justification optionnelle #}
                                <div class="mt-3">
                                    <label for="commentaire_veracite" class="form-label">Justification (optionnelle)</label>
                                    <textarea class="form-control" name="commentaire_veracite" id="commentaire_veracite" rows="2" 
                                              placeholder="Expliquez bri√®vement votre √©valuation..."></textarea>
                                </div>
                            </div>

                            {# ===== BOUTON SUBMIT ===== #}
                            <div class="d-flex justify-content-between align-items-center">
                                <small class="text-muted">
                                    <i class="fas fa-info-circle me-1"></i>
                                    Votre vote comptera avec un poids de <strong>{{ app.user.niveau }}</strong>
                                </small>
                                {{ form_widget(form.submit, {'attr': {'class': 'btn btn-primary'}}) }}
                            </div>

                        {{ form_end(form) }}
                    </div>
                </div>
            {% elseif not app.user %}
                <!-- Message pour utilisateurs non connect√©s -->
                <div class="comment-form text-center py-5 mb-4">
                    <i class="fas fa-sign-in-alt text-muted mb-3" style="font-size: 2.5rem; opacity: 0.5;"></i>
                    <h5 class="text-muted mb-3">Contribuer √† cette demande</h5>
                    <p class="text-muted mb-4">
                        Connectez-vous pour apporter votre expertise et aider √† v√©rifier cette information
                    </p>
                    <a href="{{ path('app_login') }}" class="btn text-white" style="background-color: #667eea;">
                        <i class="fas fa-sign-in-alt me-2"></i>
                        Se connecter pour contribuer
                    </a>
                </div>
            {% endif %}

            <!-- Section CONTRIBUTIONS/R√âPONSES -->
            <div class="contributions-section p-4 mb-4">
                <div class="d-flex align-items-center mb-4">
                    <div class="me-3">
                        <div class="text-white rounded-circle d-flex align-items-center justify-content-center" 
                             style="width: 50px; height: 50px; background-color: #10b981;">
                            <i class="fas fa-comments fa-lg"></i>
                        </div>
                    </div>
                    <div>
                        <h2 class="h4 mb-1 fw-bold" style="color: #10b981;">Contributions de la communaut√©</h2>
                        <small class="text-muted">V√©rifications et analyses des utilisateurs</small>
                    </div>
                </div>

                <div class="card shadow-sm mb-4">
                    <div class="card-header bg-white">
                        <div class="d-flex justify-content-between align-items-center">
                            <h3 class="h5 mb-0" style="color: #667eea;">
                                <i class="fas fa-comments me-2"></i>
                                Contributions de la communaut√©
                                <span class="badge bg-secondary ms-2">{{ demande.nbReponses }}</span>
                            </h3>
                            {% if demande.reponses|length > 0 %}
                                <small class="text-muted">
                                    <i class="fas fa-sort-amount-down me-1"></i>
                                    Du plus r√©cent au plus ancien
                                </small>
                            {% endif %}
                        </div>
                    </div>
                    <div class="card-body">
                        {% if demande.reponses|length > 0 %}
                            <!-- Liste des commentaires -->
                            {% for reponse in demande.reponses %}
                                <div class="comment-card p-4 mb-4 rounded border">
                                    <!-- üÜï En-t√™te du commentaire am√©lior√© -->
                                    <div class="d-flex align-items-start mb-3">
                                        <div class="comment-avatar me-3 {% if reponse.auteur.isJournaliste is defined and reponse.auteur.isJournaliste %}journaliste{% endif %}">
                                            {% if reponse.auteur.isJournaliste is defined and reponse.auteur.isJournaliste %}
                                                <i class="fas fa-newspaper"></i>
                                            {% else %}
                                                <i class="fas fa-user"></i>
                                            {% endif %}
                                        </div>
                                        <div class="flex-grow-1">
                                            <div class="d-flex justify-content-between align-items-start mb-2">
                                                <div>
                                                    {# Nom et badges sur la m√™me ligne #}
                                                    <div class="badges-container mb-1">
                                                        <h6 class="mb-0 fw-bold text-dark me-2">
                                                            {% if reponse.auteur.prenom or reponse.auteur.nom %}
                                                                {{ reponse.auteur.prenom }} {{ reponse.auteur.nom }}
                                                            {% else %}
                                                                {{ reponse.auteur.email|split('@')[0] }}
                                                            {% endif %}
                                                        </h6>
                                                        
                                                        {# Badge statut utilisateur (journaliste ou score) #}
                                                        {% if reponse.auteur.isJournaliste is defined and reponse.auteur.isJournaliste %}
                                                            <span class="badge badge-certifie text-dark">
                                                                <i class="fas fa-newspaper me-1"></i>
                                                                JOURNALISTE
                                                            </span>
                                                        {% else %}
                                                            {% set scoreCommentaire = reponse.auteur.scoreReputation ?? 0 %}
                                                            {% set pourcentageCommentaire = (scoreCommentaire * 100 / 100)|round %}
                                                            {% if pourcentageCommentaire >= 80 %}
                                                                <span class="badge text-white" style="background-color: #10b981;">
                                                                    <i class="fas fa-star"></i> Expert ({{ pourcentageCommentaire }}%)
                                                                </span>
                                                            {% elseif pourcentageCommentaire >= 60 %}
                                                                <span class="badge text-white" style="background-color: #667eea;">
                                                                    <i class="fas fa-thumbs-up"></i> Fiable ({{ pourcentageCommentaire }}%)
                                                                </span>
                                                            {% elseif pourcentageCommentaire >= 30 %}
                                                                <span class="badge text-dark" style="background-color: #f59e0b;">
                                                                    <i class="fas fa-user-check"></i> Correct ({{ pourcentageCommentaire }}%)
                                                                </span>
                                                            {% elseif pourcentageCommentaire > 0 %}
                                                                <span class="badge text-white" style="background-color: #f97316;">
                                                                    <i class="fas fa-exclamation-triangle"></i> D√©butant ({{ pourcentageCommentaire }}%)
                                                                </span>
                                                            {% else %}
                                                                <span class="badge text-dark" style="background-color: #e5e7eb;">
                                                                    <i class="fas fa-user-plus"></i> Nouveau
                                                                </span>
                                                            {% endif %}
                                                        {% endif %}
                                                    </div>
                                                    
                                                    {# Informations compl√©mentaires #}
                                                    <div class="d-flex align-items-center gap-2">
                                                        <small class="text-muted">
                                                            {% if reponse.auteur.isJournaliste is defined and reponse.auteur.isJournaliste %}
                                                                <i class="fas fa-star me-1" style="color: #f59e0b;"></i>Journaliste accr√©dit√©
                                                            {% else %}
                                                                <i class="fas fa-users me-1"></i>Contributeur
                                                            {% endif %}
                                                        </small>
                                                        <span class="text-muted">‚Ä¢</span>
                                                        <small class="text-muted">
                                                            <i class="fas fa-clock me-1"></i>
                                                            {{ reponse.dateCreation|date('d/m/Y √† H:i') }}
                                                        </small>
                                                    </div>
                                                </div>

                                                {# ===== VOTE DE V√âRACIT√â AVEC DESIGN AM√âLIOR√â ===== #}
                                                {% set voteVeracite = null %}
                                                {% for vote in demande.votesVeracite %}
                                                    {% if vote.user == reponse.auteur %}
                                                        {% set voteVeracite = vote %}
                                                    {% endif %}
                                                {% endfor %}

                                                {% if voteVeracite %}
                                                    <div class="badges-container">
                                                        {# Badge principal du vote #}
                                                        <span class="badge vote-veracite {{ voteVeracite.typeVote }} badge-veracite-journaliste" 
                                                              style="background-color: {{ voteVeracite.couleurVote }}; color: white;">
                                                            <i class="{{ voteVeracite.iconeVote }} me-2"></i>
                                                            <strong>{{ voteVeracite.libelleVote }}</strong>
                                                        </span>
                                                        
                                                        {# Badge "CERTIFI√âE" pour les journalistes #}
                                                        {% if reponse.auteur.isJournaliste is defined and reponse.auteur.isJournaliste %}
                                                            <span class="badge badge-certifie text-dark px-2 py-1" 
                                                                  title="√âvaluation certifi√©e par un journaliste accr√©dit√©" 
                                                                  data-bs-toggle="tooltip">
                                                                <i class="fas fa-certificate me-1"></i>
                                                                <strong>CERTIFI√âE</strong>
                                                            </span>
                                                        {% endif %}
                                                        
                                                        {# Ic√¥ne justification si commentaire fourni #}
                                                        {% if voteVeracite.commentaire %}
                                                            <i class="fas fa-comment-dots justification-tooltip" 
                                                               title="Justification : {{ voteVeracite.commentaire }}" 
                                                               data-bs-toggle="tooltip"
                                                               data-bs-placement="left"></i>
                                                        {% endif %}
                                                    </div>
                                                {% else %}
                                                    {# Pas de vote de v√©racit√© mais journaliste #}
                                                    {% if reponse.auteur.isJournaliste is defined and reponse.auteur.isJournaliste %}
                                                        <span class="badge bg-secondary text-white px-2 py-1">
                                                            <i class="fas fa-hourglass-half me-1"></i>
                                                            √âvaluation en attente
                                                        </span>
                                                    {% endif %}
                                                {% endif %}
                                            </div>
                                            
                                            <!-- Contenu du commentaire -->
                                            <div class="comment-content mb-3">
                                                <p class="mb-0 lh-lg text-dark">{{ reponse.contenu|nl2br }}</p>
                                            </div>
                                            
                                            <!-- Sources si pr√©sentes -->
                                            {% if reponse.sources %}
                                                <div class="sources-section mb-3 p-3 bg-light rounded border">
                                                    <small class="text-muted fw-bold d-block mb-2">
                                                        <i class="fas fa-link me-1"></i>Sources r√©f√©renc√©es :
                                                    </small>
                                                    {% set sources = reponse.sources|split('\n') %}
                                                    {% for source in sources %}
                                                        {% if source|trim %}
                                                            <div class="source-item mb-1">
                                                                {% if 'http' in source %}
                                                                    <i class="fas fa-external-link-alt me-1" style="color: #667eea; font-size: 0.8rem;"></i>
                                                                    <a href="{{ source|trim }}" target="_blank" class="text-decoration-none small" style="color: #667eea;">
                                                                        {{ source|trim }}
                                                                    </a>
                                                                {% elseif 'Image:' in source %}
                                                                <div class="uploaded-image">
                                                                    <i class="fas fa-image text-info me-1" style="font-size: 0.8rem;"></i>
                                                                    <span class="small text-muted d-block mb-2">{{ source|trim }}</span>
                                                                    {% set imageName = source|replace({'Image: ': ''}) %}
                                                                    <img src="{{ asset('uploads/images/' ~ imageName|trim) }}" 
                                                                        alt="Image partag√©e" 
                                                                        class="img-fluid rounded shadow-sm" 
                                                                        style="max-width: 300px; max-height: 200px; object-fit: cover;">
                                                                </div>
                                                                {% else %}
                                                                    <i class="fas fa-file-alt text-secondary me-1" style="font-size: 0.8rem;"></i>
                                                                    <span class="small">{{ source|trim }}</span>
                                                                {% endif %}
                                                            </div>
                                                        {% endif %}
                                                    {% endfor %}
                                                </div>
                                            {% endif %}
                                            
                                            <!-- Actions du commentaire -->
                                            <div class="comment-actions d-flex justify-content-between align-items-center mt-3">
                                                {% if app.user and app.user != reponse.auteur %}
                                                    {# ACTIONS POUR LES AUTRES UTILISATEURS #}
                                                    <div class="vote-buttons">
                                                        <button class="btn btn-outline-success vote-btn me-2" 
                                                                data-reponse-id="{{ reponse.id }}" 
                                                                data-type="utile">
                                                            <i class="fas fa-thumbs-up me-1"></i>
                                                            Utile
                                                            <span class="badge bg-success ms-1" id="votes-positifs-{{ reponse.id }}">{{ reponse.nbVotesPositifs ?? 0 }}</span>
                                                        </button>
                                                        <button class="btn btn-outline-secondary vote-btn me-2" 
                                                                data-reponse-id="{{ reponse.id }}" 
                                                                data-type="pas_utile">
                                                            <i class="fas fa-thumbs-down me-1"></i>
                                                            Pas utile
                                                            <span class="badge bg-secondary ms-1" id="votes-negatifs-{{ reponse.id }}">{{ reponse.nbVotesNegatifs ?? 0 }}</span>
                                                        </button>
                                                    </div>
                                                    <div class="other-actions">
                                                        <a href="{{ path('report_contenu', {type: 'reponse', id: reponse.id}) }}" 
                                                        class="btn btn-sm btn-outline-warning">
                                                            <i class="fas fa-flag me-1"></i>Signaler
                                                        </a>
                                                    </div>
                                                {% elseif app.user and app.user == reponse.auteur %}
                                                    {# üÜï ACTIONS POUR L'AUTEUR DE LA R√âPONSE #}
                                                    <div class="vote-display">
                                                        <small class="text-muted">
                                                            <i class="fas fa-thumbs-up me-1"></i>{{ reponse.nbVotesPositifs ?? 0 }} utile(s) ‚Ä¢ 
                                                            <i class="fas fa-thumbs-down me-1"></i>{{ reponse.nbVotesNegatifs ?? 0 }} pas utile(s)
                                                        </small>
                                                    </div>
                                                    <div class="author-actions">
                                                        {# BOUTON SUPPRIMER #}
                                                        <button type="button" 
                                                                class="btn btn-sm btn-outline-danger" 
                                                                data-bs-toggle="modal" 
                                                                data-bs-target="#modalSuppressionReponse"
                                                                data-reponse-id="{{ reponse.id }}"
                                                                data-reponse-apercu="{{ reponse.contenu|slice(0, 80)|striptags|e('html_attr') }}{{ reponse.contenu|length > 80 ? '...' : '' }}"
                                                                data-csrf-token="{{ csrf_token('supprimer_reponse_' ~ reponse.id) }}">
                                                            <i class="fas fa-trash me-1"></i>Supprimer
                                                        </button>
                                                    </div>
                                                {% else %}
                                                    {# UTILISATEUR NON CONNECT√â #}
                                                    <div class="text-center text-muted w-100">
                                                        <small>
                                                            <i class="fas fa-thumbs-up me-1"></i>{{ reponse.nbVotesPositifs ?? 0 }} utile(s) ‚Ä¢ 
                                                            <i class="fas fa-thumbs-down me-1"></i>{{ reponse.nbVotesNegatifs ?? 0 }} pas utile(s)
                                                        </small>
                                                    </div>
                                                {% endif %}
                                            </div>
                
                                        </div>
                                    </div>
                                </div>
                            {% endfor %}
                            
                        {% else %}
                            <!-- Message quand aucun commentaire -->
                            <div class="no-comments text-center py-5">
                                <i class="fas fa-comment-dots text-muted mb-3" style="font-size: 3rem; opacity: 0.3;"></i>
                                <h5 class="text-muted mb-3">Aucune contribution pour le moment</h5>
                                <p class="text-muted mb-0">
                                    Soyez le premier √† apporter des √©l√©ments de v√©rification pour cette demande !
                                </p>
                            </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>

        <!-- Sidebar -->
        <div class="col-lg-4">
            <!-- Informations de la demande -->
            <div class="info-card p-3 mb-4">
                <h5 class="fw-bold mb-3" style="color: #667eea;">
                    <i class="fas fa-info-circle me-2"></i>
                    Informations
                </h5>
                
                <div class="mb-2">
                    <strong>Date de cr√©ation :</strong>
                    <span class="ms-2">{{ demande.dateCreation|date('d/m/Y √† H:i') }}</span>
                </div>
                
                {% if demande.dateModification is defined and demande.dateModification %}
                    <div class="mb-2">
                        <strong>Derni√®re modification :</strong>
                        <span class="ms-2">{{ demande.dateModification|date('d/m/Y √† H:i') }}</span>
                    </div>
                {% endif %}
                
                <div class="mb-2">
                    <strong>Contributions :</strong>
                    <span class="ms-2">{{ demande.nbReponses }}</span>
                </div>

                {% if demande.categorie %}
                    <div class="mb-2">
                        <strong>Cat√©gorie :</strong>
                        <span class="ms-2">{{ demande.categorie.nom }}</span>
                    </div>
                {% endif %}
            </div>

            <!-- Actions -->
            <div class="card shadow-sm">
                <div class="card-header bg-white">
                    <h4 class="h6 mb-0" style="color: #667eea;">
                        <i class="fas fa-cogs me-2"></i>
                        Actions
                    </h4>
                </div>
                <div class="card-body">
                    <div class="d-grid gap-2">
                        {% if app.user %}
                            <a href="#form-contribution" class="btn text-white scroll-to-form" style="background-color: #667eea;">
                                <i class="fas fa-plus me-2"></i>
                                Contribuer
                            </a>
                        {% else %}
                            <a href="{{ path('app_login') }}" class="btn text-white" style="background-color: #667eea;">
                                <i class="fas fa-sign-in-alt me-2"></i>
                                Se connecter pour contribuer
                            </a>
                        {% endif %}
                        
                        <button class="btn btn-outline-secondary" onclick="partagerDemande()">
                            <i class="fas fa-share-alt me-2"></i>
                            Partager
                        </button>
                        
                        {# üÜï BOUTON SUPPRIMER DEMANDE - VISIBLE SEULEMENT POUR L'AUTEUR #}
                        {% if app.user and app.user == demande.auteur %}
                            <button type="button" 
                                    class="btn btn-outline-danger" 
                                    data-bs-toggle="modal" 
                                    data-bs-target="#modalSuppressionDemande"
                                    data-demande-id="{{ demande.id }}"
                                    data-demande-titre="{{ demande.titre|e('html_attr') }}"
                                    data-nb-reponses="{{ demande.nbReponses }}"
                                    data-nb-votes="{{ demande.votesVeracite|length }}"
                                    data-csrf-token="{{ csrf_token('supprimer_demande_' ~ demande.id) }}">
                                <i class="fas fa-trash me-2"></i>Supprimer cette demande
                            </button>
                        {% endif %}
                        
                        {# BOUTON SIGNALER - VISIBLE POUR LES AUTRES UTILISATEURS #}
                        {% if app.user and app.user != demande.auteur %}
                            <a href="{{ path('report_contenu', {type: 'demande', id: demande.id}) }}" 
                            class="btn btn-outline-warning">
                                <i class="fas fa-flag me-2"></i>Signaler
                            </a>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Bouton retour -->
    <div class="text-center mt-5">
        <a href="{{ path('app_home') }}" class="btn btn-outline-primary">
            <i class="fas fa-arrow-left me-2"></i>
            Retour √† la liste des demandes
        </a>
    </div>
</div>

<!-- üÜï MODAL DE CONFIRMATION DE SUPPRESSION DES COMMENTAIRES -->
<div class="modal fade" id="modalSuppressionReponse" tabindex="-1" aria-labelledby="modalSuppressionReponseLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title" id="modalSuppressionReponseLabel">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    Confirmer la suppression
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-warning border-0">
                    <div class="d-flex align-items-center">
                        <i class="fas fa-exclamation-triangle fa-2x text-warning me-3"></i>
                        <div>
                            <h6 class="alert-heading mb-1">Action irr√©versible</h6>
                            <p class="mb-0">Cette action supprimera d√©finitivement votre commentaire.</p>
                        </div>
                    </div>
                </div>
                
                <p class="mb-3">√ätes-vous s√ªr de vouloir supprimer ce commentaire ?</p>
                
                <div class="bg-light p-3 rounded border">
                    <label class="form-label text-muted small mb-2">
                        <i class="fas fa-comment me-1"></i>Aper√ßu du commentaire :
                    </label>
                    <div id="apercu-commentaire-modal" class="fw-bold text-dark"></div>
                </div>
                
                <div class="mt-3">
                    <small class="text-muted">
                        <i class="fas fa-info-circle me-1"></i>
                        Les votes et interactions li√©s √† ce commentaire seront √©galement supprim√©s.
                    </small>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times me-1"></i>Annuler
                </button>
                <button type="button" class="btn btn-danger" id="confirmer-suppression-btn">
                    <i class="fas fa-trash me-1"></i>Supprimer d√©finitivement
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Formulaire cach√© pour la suppression des commentaires -->
<form id="form-suppression-reponse" method="POST" style="display: none;">
    <input type="hidden" name="_token" id="csrf-token-suppression" value="">
</form>

<!-- üÜï MODAL DE CONFIRMATION DE SUPPRESSION DE DEMANDE -->
<div class="modal fade" id="modalSuppressionDemande" tabindex="-1" aria-labelledby="modalSuppressionDemandeLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title" id="modalSuppressionDemandeLabel">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    Supprimer la demande
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-danger border-0">
                    <div class="d-flex align-items-center">
                        <i class="fas fa-exclamation-triangle fa-3x text-danger me-3"></i>
                        <div>
                            <h5 class="alert-heading mb-2">‚ö†Ô∏è Action IRR√âVERSIBLE</h5>
                            <p class="mb-0">
                                <strong>Cette action supprimera d√©finitivement votre demande</strong> 
                                ainsi que toutes les contributions de la communaut√©.
                            </p>
                        </div>
                    </div>
                </div>
                
                <div class="row mb-4">
                    <div class="col-md-8">
                        <h6 class="text-danger mb-3">
                            <i class="fas fa-file-alt me-2"></i>Demande √† supprimer :
                        </h6>
                        <div class="bg-light p-3 rounded border">
                            <div id="titre-demande-modal" class="fw-bold text-dark mb-2"></div>
                            <small class="text-muted">ID #{{ demande.id }}</small>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <h6 class="text-warning mb-3">
                            <i class="fas fa-chart-bar me-2"></i>Impact :
                        </h6>
                        <div class="d-flex flex-column gap-2">
                            <div class="d-flex align-items-center">
                                <i class="fas fa-comments text-info me-2"></i>
                                <span id="nb-reponses-modal">0</span> contribution(s)
                            </div>
                            <div class="d-flex align-items-center">
                                <i class="fas fa-vote-yea text-success me-2"></i>
                                <span id="nb-votes-modal">0</span> √©valuation(s)
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="bg-warning bg-opacity-10 border border-warning rounded p-3 mb-3">
                    <h6 class="text-warning mb-2">
                        <i class="fas fa-users me-2"></i>Cons√©quences pour la communaut√© :
                    </h6>
                    <ul class="mb-0 small">
                        <li>Toutes les <strong>contributions des utilisateurs</strong> seront perdues</li>
                        <li>Tous les <strong>votes et √©valuations</strong> seront supprim√©s</li>
                        <li>Le <strong>travail de v√©rification</strong> de la communaut√© sera perdu</li>
                        <li>Cette action <strong>ne peut pas √™tre annul√©e</strong></li>
                    </ul>
                </div>
                
                <div class="form-check mb-3">
                    <input class="form-check-input" type="checkbox" id="confirmeComprehension">
                    <label class="form-check-label fw-bold" for="confirmeComprehension">
                        Je comprends que cette action est irr√©versible et supprimera tout le contenu associ√©
                    </label>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times me-1"></i>Annuler
                </button>
                <button type="button" class="btn btn-danger" id="confirmer-suppression-demande-btn" disabled>
                    <i class="fas fa-trash me-1"></i>Supprimer d√©finitivement
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Formulaire cach√© pour la suppression de demande -->
<form id="form-suppression-demande" method="POST" style="display: none;">
    <input type="hidden" name="_token" id="csrf-token-suppression-demande" value="">
</form>

{% endblock %}

{% block javascripts %}
    {{ parent() }}
    <script src="{{ asset('js/detail.js') }}"></script>
    <script>
    // üóëÔ∏è GESTION DE LA SUPPRESSION DES R√âPONSES
    document.addEventListener('DOMContentLoaded', function() {
        const modal = document.getElementById('modalSuppressionReponse');
        const apercuElement = document.getElementById('apercu-commentaire-modal');
        const confirmerBtn = document.getElementById('confirmer-suppression-btn');
        const form = document.getElementById('form-suppression-reponse');
        const tokenInput = document.getElementById('csrf-token-suppression');
        
        let reponseIdASupprimer = null;
        let csrfTokenAUtiliser = null;
        
        // √âv√©nement d'ouverture de la modal
        if (modal) {
            modal.addEventListener('show.bs.modal', function(event) {
                const button = event.relatedTarget;
                
                // R√©cup√©rer les donn√©es du bouton
                reponseIdASupprimer = button.getAttribute('data-reponse-id');
                const apercu = button.getAttribute('data-reponse-apercu');
                csrfTokenAUtiliser = button.getAttribute('data-csrf-token');
                
                // Mettre √† jour l'aper√ßu
                apercuElement.textContent = apercu;
            });
        }
        
        // √âv√©nement de confirmation
        if (confirmerBtn) {
            confirmerBtn.addEventListener('click', function() {
                if (!reponseIdASupprimer || !csrfTokenAUtiliser) {
                    alert('Erreur : Donn√©es manquantes pour la suppression.');
                    return;
                }
                
                // D√©sactiver le bouton pour √©viter les doubles clics
                confirmerBtn.disabled = true;
                confirmerBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Suppression...';
                
                // Configurer et soumettre le formulaire
                form.action = '/demande/reponse/' + reponseIdASupprimer + '/supprimer';
                tokenInput.value = csrfTokenAUtiliser;
                form.submit();
            });
        }
        
        // R√©initialiser la modal √† la fermeture
        if (modal) {
            modal.addEventListener('hidden.bs.modal', function() {
                reponseIdASupprimer = null;
                csrfTokenAUtiliser = null;
                if (confirmerBtn) {
                    confirmerBtn.disabled = false;
                    confirmerBtn.innerHTML = '<i class="fas fa-trash me-1"></i>Supprimer d√©finitivement';
                }
            });
        }

        // üóëÔ∏è GESTION DE LA SUPPRESSION DES DEMANDES
        const modalDemande = document.getElementById('modalSuppressionDemande');
        const titreElement = document.getElementById('titre-demande-modal');
        const nbReponsesElement = document.getElementById('nb-reponses-modal');
        const nbVotesElement = document.getElementById('nb-votes-modal');
        const confirmerBtnDemande = document.getElementById('confirmer-suppression-demande-btn');
        const formDemande = document.getElementById('form-suppression-demande');
        const tokenInputDemande = document.getElementById('csrf-token-suppression-demande');
        const checkboxConfirmation = document.getElementById('confirmeComprehension');
        
        let demandeIdASupprimer = null;
        let csrfTokenDemandeAUtiliser = null;
        
        // √âv√©nement d'ouverture de la modal
        if (modalDemande) {
            modalDemande.addEventListener('show.bs.modal', function(event) {
                const button = event.relatedTarget;
                
                // R√©cup√©rer les donn√©es du bouton
                demandeIdASupprimer = button.getAttribute('data-demande-id');
                const titreDemande = button.getAttribute('data-demande-titre');
                const nbReponses = button.getAttribute('data-nb-reponses');
                const nbVotes = button.getAttribute('data-nb-votes');
                csrfTokenDemandeAUtiliser = button.getAttribute('data-csrf-token');
                
                // Mettre √† jour les informations
                if (titreElement) titreElement.textContent = titreDemande;
                if (nbReponsesElement) nbReponsesElement.textContent = nbReponses;
                if (nbVotesElement) nbVotesElement.textContent = nbVotes;
                
                // R√©initialiser la checkbox
                if (checkboxConfirmation) checkboxConfirmation.checked = false;
                if (confirmerBtnDemande) confirmerBtnDemande.disabled = true;
            });
        }
        
        // Gestion de la checkbox de confirmation
        if (checkboxConfirmation) {
            checkboxConfirmation.addEventListener('change', function() {
                if (confirmerBtnDemande) {
                    confirmerBtnDemande.disabled = !this.checked;
                }
            });
        }
        
        // √âv√©nement de confirmation
        if (confirmerBtnDemande) {
            confirmerBtnDemande.addEventListener('click', function() {
                if (!demandeIdASupprimer || !csrfTokenDemandeAUtiliser) {
                    alert('Erreur : Donn√©es manquantes pour la suppression.');
                    return;
                }
                
                if (!checkboxConfirmation.checked) {
                    alert('Veuillez confirmer que vous comprenez les cons√©quences de cette action.');
                    return;
                }
                
                // D√©sactiver le bouton pour √©viter les doubles clics
                confirmerBtnDemande.disabled = true;
                confirmerBtnDemande.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Suppression en cours...';
                
                // Configurer et soumettre le formulaire
                formDemande.action = '/demande/' + demandeIdASupprimer + '/supprimer';
                tokenInputDemande.value = csrfTokenDemandeAUtiliser;
                formDemande.submit();
            });
        }
        
        // R√©initialiser la modal √† la fermeture
        if (modalDemande) {
            modalDemande.addEventListener('hidden.bs.modal', function() {
                demandeIdASupprimer = null;
                csrfTokenDemandeAUtiliser = null;
                if (checkboxConfirmation) checkboxConfirmation.checked = false;
                if (confirmerBtnDemande) {
                    confirmerBtnDemande.disabled = true;
                    confirmerBtnDemande.innerHTML = '<i class="fas fa-trash me-1"></i>Supprimer d√©finitivement';
                }
            });
        }
    });
    </script>
{% endblock %}